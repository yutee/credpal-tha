#cloud-config

package_update: true
package_upgrade: true

packages:
  - docker.io
  - docker-compose
  - nginx
  - certbot
  - python3-certbot-nginx
  - git

groups:
  - docker

system_info:
  default_user:
    groups: [docker]

write_files:
  - path: /etc/nginx/sites-available/app
    content: |
      server {
          listen 80;
          server_name ${domain_name};

          location /.well-known/acme-challenge/ {
              root /var/www/html;
          }

          location / {
              return 301 https://$host$request_uri;
          }
      }

      server {
          listen 443 ssl http2;
          server_name ${domain_name};

          ssl_certificate /etc/letsencrypt/live/${domain_name}/fullchain.pem;
          ssl_certificate_key /etc/letsencrypt/live/${domain_name}/privkey.pem;

          ssl_protocols TLSv1.2 TLSv1.3;
          ssl_ciphers HIGH:!aNULL:!MD5;
          ssl_prefer_server_ciphers on;

          location / {
              proxy_pass http://localhost:3000;
              proxy_http_version 1.1;
              proxy_set_header Upgrade $http_upgrade;
              proxy_set_header Connection 'upgrade';
              proxy_set_header Host $host;
              proxy_set_header X-Real-IP $remote_addr;
              proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
              proxy_set_header X-Forwarded-Proto $scheme;
              proxy_cache_bypass $http_upgrade;
          }

          location /health {
              proxy_pass http://localhost:3000/health;
              access_log off;
          }
      }

  - path: /opt/app/docker-compose.yml
    content: |
      services:
        app:
          image: ghcr.io/${github_repo}:latest
          container_name: node-app
          restart: unless-stopped
          ports:
            - "3000:3000"
          environment:
            PORT: 3000
            DB_HOST: postgres
            DB_PORT: 5432
            DB_NAME: appdb
            DB_USER: appuser
            DB_PASSWORD: ${db_password}
            NODE_ENV: production
          depends_on:
            postgres:
              condition: service_healthy

        postgres:
          image: postgres:16-alpine
          container_name: postgres
          restart: unless-stopped
          environment:
            POSTGRES_DB: appdb
            POSTGRES_USER: appuser
            POSTGRES_PASSWORD: ${db_password}
          volumes:
            - postgres_data:/var/lib/postgresql/data
          healthcheck:
            test: ["CMD-SHELL", "pg_isready -U appuser"]
            interval: 5s
            timeout: 5s
            retries: 5

      volumes:
        postgres_data:

  - path: /usr/local/bin/setup-ssl.sh
    permissions: '0755'
    content: |
      #!/bin/bash
      set -e
      
      DOMAIN="${domain_name}"
      EMAIL="${letsencrypt_email}"
      
      echo "Waiting for DNS propagation..."
      for i in {1..30}; do
        if host $DOMAIN | grep "has address"; then
          echo "DNS resolved successfully"
          break
        fi
        echo "Attempt $i/30: DNS not ready yet, waiting..."
        sleep 10
      done
      
      echo "Obtaining SSL certificate..."
      certbot certonly --nginx \
        --non-interactive \
        --agree-tos \
        --email $EMAIL \
        -d $DOMAIN \
        || echo "Certificate acquisition failed, will retry later"
      
      if [ -f "/etc/letsencrypt/live/$DOMAIN/fullchain.pem" ]; then
        echo "Certificate obtained successfully"
        systemctl reload nginx
      else
        echo "Certificate not available yet, nginx will serve HTTP only"
      fi

  - path: /etc/systemd/system/certbot-renewal.timer
    content: |
      [Unit]
      Description=Certbot renewal timer
      
      [Timer]
      OnCalendar=daily
      RandomizedDelaySec=1h
      Persistent=true
      
      [Install]
      WantedBy=timers.target

  - path: /etc/systemd/system/certbot-renewal.service
    content: |
      [Unit]
      Description=Certbot renewal
      
      [Service]
      Type=oneshot
      ExecStart=/usr/bin/certbot renew --quiet --deploy-hook "systemctl reload nginx"

runcmd:
  - systemctl enable docker
  - systemctl start docker
  - systemctl enable nginx
  - systemctl start nginx
  - ln -sf /etc/nginx/sites-available/app /etc/nginx/sites-enabled/app
  - rm -f /etc/nginx/sites-enabled/default
  - nginx -t && systemctl reload nginx
  - sleep 10
  - /usr/local/bin/setup-ssl.sh
  - systemctl enable certbot-renewal.timer
  - systemctl start certbot-renewal.timer
  - cd /opt/app && docker-compose pull
  - cd /opt/app && docker-compose up -d
  - echo "Setup complete" > /var/log/cloud-init-complete.log